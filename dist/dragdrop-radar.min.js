/*! dragdrop-radar 26-08-2015 */
!function(a,b){"use strict";function c(a){this._config=e(d,a),this._data=a.data,this.dispatchOnChange=d3.dispatch("change"),this.redrawRadar()}var d={width:"600",height:"400",radarHandlersRadius:5,minRadius:20,radarPathInterpolation:"linear-closed",maxValue:100,radarMargin:.1,exponent:2,grid:0,axeLabelsSpace:2,equalize:!0,showAxeLabels:!0,labelPosition:"outer",showValuesOnLabels:!0,showValuesOnTooltip:!0,showToolTip:!0,measureUnit:"%",decimalValues:0,editable:!0,zoomOnMaxValue:!1,element:".radar"},e=function(a,c){var d=[];for(var e in a)d[e]=c[e]!==b?c[e]:a[e];return d};c.prototype={VERSION:"0.0.0",config:function(a,b){return 1==arguments.length?this._config[a]:(this._config[a]=b,this)},data:function(a){return 0===arguments.length?this._data:void(this._data=a)},change:function(a,b){this.dispatchOnChange.on(a,b)},redrawRadar:function(){var a=this;return this._config.svgCenter={x:this._config.width/2,y:this._config.height/2},this.coordG=this.getPolarCoordGenerator(this._config.svgCenter),this._config.radarRadius=Math.min(this._config.height,this._config.width)/2-this._config.radarHandlersRadius,this.angleCalculator=this.equalAngleCalculator(this._data.length,-Math.PI/2),this._config.total=0,this._config.maxFoundValue=0,this._data.forEach(function(b,c,d){d[c].i=c,d[c].gridLine={p0:{x:0,y:0},p1:{x:0,p:0}},d[c].defaultConfig=a._config,a._config.total+=b.value,b.value>a._config.maxFoundValue&&(a._config.maxFoundValue=b.value)}),this._config.maxValue=Math.max(this._config.maxValue,this._config.total),this._config.domainRange=this._config.zoomOnMaxValue?[0,a._config.maxFoundValue]:[0,a._config.maxValue],this.scale=d3.scale.pow().exponent(1/a._config.exponent).domain(this._config.domainRange).range([a._config.minRadius,a._config.radarRadius*(1-a._config.radarMargin)]),this.svg===b&&(this.svg=d3.select(a._config.element).append("svg")),this.svg.attr("width",a._config.width).attr("height",a._config.height),this.drawRadarGrid(),this.drawRadarPath(),this.drawRadarHandlers(),this},drawDataLabels:function(){var a=this;if("none"!==a._config.labelPosition){var b=this.svg.selectAll("text.data-labels").data(a._data);b.enter().append("text").attr("class","data-labels"),b.text(function(b){return b.name+(b.defaultConfig.showValuesOnLabels?" ("+b.value.toFixed(a._config.decimalValues)+a._config.measureUnit+")":"")}),"inner"===a._config.labelPosition?b.attr("transform",function(b,c){var d=a.coordG(a.angleCalculator(c),a._config.radarRadius-100);return"translate("+d.x+","+d.y+") rotate("+a.angleCalculator(c)*(180/Math.PI)+")"}).attr("dy",-4):"outer"===a._config.labelPosition&&b.attr("transform",function(b,c){var d=a.coordG(a.angleCalculator(c),a._config.radarRadius-5);return"translate("+d.x+","+d.y+")"}).attr("text-anchor",function(b,c){return Math.cos(a.angleCalculator(c))<0?"end":"start"})}},drawAxeLabels:function(){var a=this,b=this.svg.selectAll("text.axe-labels").data(a.valueGrid);b.enter().append("text").attr("class","axe-labels"),b.text(function(b){return b.toFixed(a._config.decimalValues)+a._config.measureUnit}).attr("x",a._config.svgCenter.x).attr("y",function(b){return a._config.svgCenter.y-a.scale(b)-a._config.axeLabelsSpace})},drawRadarGrid:function(){var a=this;a.valueGrid=[],a._config.grid!==b&&a._config.grid>0&&(a.valueGrid=d3.range(0,a._config.domainRange[1],a._config.domainRange[1]/a._config.grid)),a.valueGrid.push(a._config.domainRange[1]);var c=this.svg.selectAll("circle.radar-grid").data(a.valueGrid);c.enter().append("circle").attr("class",function(b){return b===a._config.domainRange[1]?"radar-grid external-circle":"radar-grid"}),c.attr("cx",a._config.svgCenter.x).attr("cy",a._config.svgCenter.y).attr("r",function(b){return a.scale(b)}),c.exit().remove(),this._config.showAxeLabels&&this.drawAxeLabels();var d=this.svg.selectAll("line").data(a._data);d.enter().append("line").attr("class","radar-grid"),d.attr("x1",function(b,c){var d=a.coordG(a.angleCalculator(c),a._config.minRadius);return b.gridLine.p0.x=d.x,b.gridLine.p0.y=d.y,d.x}).attr("y1",function(b,c){return a.coordG(a.angleCalculator(c),a._config.minRadius).y}).attr("x2",function(b,c){var d=a.coordG(a.angleCalculator(c),b.defaultConfig.radarRadius);return b.gridLine.p1.x=d.x,b.gridLine.p1.y=d.y,d=a.coordG(a.angleCalculator(c),a._config.radarRadius*(1-a._config.radarMargin)),d.x}).attr("y2",function(b,c){return a.coordG(a.angleCalculator(c),a._config.radarRadius*(1-a._config.radarMargin)).y}),d.exit().remove(),this.drawDataLabels()},drawRadarPath:function(){var a=this,b=d3.svg.line().x(function(b,c){return a.coordG(a.angleCalculator(c),a.scale(b.value)).x}).y(function(b,c){return a.coordG(a.angleCalculator(c),a.scale(b.value)).y}).interpolate(a._config.radarPathInterpolation),c=this.svg.selectAll("path").data([a._data]);c.enter().append("path").attr("stroke-width",2).attr("class","radar-path"),c.attr("d",b(a._data))},dragmove:function(a,b){function c(a){return a*a}function d(a,b){return c(a.x-b.x)+c(a.y-b.y)}function e(a,b,c){var e=d(b,c);if(0===e)return d(a,b);var f=((a.x-b.x)*(c.x-b.x)+(a.y-b.y)*(c.y-b.y))/e;if(0>f)return d(a,b);if(f>1)return d(a,c);var g={x:b.x+f*(c.x-b.x),y:b.y+f*(c.y-b.y)};return g}var f=e({x:d3.event.x,y:d3.event.y},a.gridLine.p0,a.gridLine.p1),g=Math.sqrt(d(a.gridLine.p0,f)),h=d3.scale.pow().exponent(b._config.exponent).domain([0,b._config.radarRadius*(1-b._config.radarMargin)]).range(this._config.domainRange),i=h(g);if(i=Math.min(i,b._config.domainRange[1]),!isNaN(i))if(b._config.equalize){var j=a.value-i,k=j/(a.defaultConfig.total-a.value),l=0;b._data.forEach(function(b,c){a.i!==c&&(b.value+=k*b.value),l+=b.value}),l=l-a.value+i;var m=l-b._config.total;a.value=i-m}else a.value=i;b.dispatchOnChange.change.apply(a),this.drawRadarPath(),this.drawRadarHandlers(),this.drawDataLabels()},drawRadarHandlers:function(){var a=this,b=this.svg.selectAll("circle.radar-handlers").data(a._data);if(b.enter().append("circle").attr("r",a._config.radarHandlersRadius).attr("class","radar-handlers"),b.attr("cx",function(b,c){var d=a.coordG(a.angleCalculator(c),a.scale(b.value));return b.x=d.x,b.y=d.y,d.x}).attr("cy",function(b,c){return a.coordG(a.angleCalculator(c),a.scale(b.value)).y}),this._config.editable){var c=d3.behavior.drag().origin(function(a){return a}).on("drag",function(b){a.dragmove(b,a)});b.call(c)}a._config.showToolTip===!0&&b.on("mouseover",function(b){b.tooltip="visible",a.drawRadarHandlers()}),b.on("mouseout",function(b){b.tooltip="none",a.drawRadarHandlers()});var d=this.svg.selectAll("text.radar-tooltip").data(a._data);d.enter().append("text").attr("class","radar-tooltip"),d.text(function(b){return b.name+(b.defaultConfig.showValuesOnTooltip?" ("+b.value.toFixed(a._config.decimalValues)+a._config.measureUnit+")":"")}).attr("x",function(b,c){return a.coordG(a.angleCalculator(c),a.scale(b.value)+5).x}).attr("y",function(b,c){return a.coordG(a.angleCalculator(c),a.scale(b.value)+5).y}).attr("text-anchor",function(b,c){return Math.cos(a.angleCalculator(c))<0?"end":"start"}).style("visibility",function(a){return"visible"===a.tooltip?"visible":"hidden"})},equalAngleCalculator:function(a,b){return function(c){return 2*Math.PI/a*c+b}},getPolarCoordGenerator:function(a){return function(b,c){var d={x:c*Math.cos(b)+a.x,y:c*Math.sin(b)+a.y};return d}},getConfig:function(){return d}},a.dragdropRadar=c}(this);